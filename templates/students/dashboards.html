{% extends 'students/base.html' %}

{% block content %}
<style>
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 2rem; 
        background-color: #f8f9fa;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 2rem;
        font-size: 2.5rem;
        font-weight: 600;
    }
    
    .form-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        border-left: 4px solid #667eea;
    }
    
    .input-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    input {
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 1rem;
        flex: 1;
        min-width: 200px;
        transition: border-color 0.3s;
    }
    
    input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 1rem;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }
    
    td {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    tr:hover {
        background-color: #f8f9fa;
    }
    
    .alert {
        padding: 1rem;
        border-radius: 6px;
        margin: 1rem 0;
        display: none;
    }
    
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>

<div class="container">
    <h1>ðŸ“š Student Management System</h1>
    
    <!-- Add Student Form -->
    <div class="form-section">
        <h3>Add New Student</h3>
        <div class="input-group">
            <input id="name" placeholder="Full Name" required>
            <input id="email" type="email" placeholder="Email Address" required>
            <input id="grade" placeholder="Grade (e.g., 10th)" required>
            <button onclick="addStudent()">âž• Add Student</button>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alert" class="alert"></div>

    <!-- Students Table -->
    <table id="studentTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Grade</th>
                <th>Email</th>
                <th>Joined Date</th>
            </tr>
        </thead>
        <tbody id="studentsTableBody">
            <!-- Students will be loaded here -->
        </tbody>
    </table>
</div>

<script>
    // Load students when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, fetching students...');
        loadStudents();
    });

    async function loadStudents() {
        try {
            console.log('Starting to load students...');
            
            const res = await fetch('/api/students/');
            console.log('Response status:', res.status);
            
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const data = await res.json();
            console.log('API Response:', data);
            
            const tableBody = document.getElementById('studentsTableBody');
            
            if (!tableBody) {
                console.error('Table body element not found!');
                return;
            }
            
            tableBody.innerHTML = ''; // Clear existing rows
            
            // Check if data is an array, if not, try to extract results
            let studentsArray = data;
            
            // If data has a 'results' property (common in DRF pagination)
            if (data && data.results && Array.isArray(data.results)) {
                studentsArray = data.results;
                console.log('Using paginated results:', studentsArray);
            }
            // If data is not an array at all
            else if (!Array.isArray(data)) {
                console.error('Data is not an array:', data);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: red;">
                            API returned unexpected format. Check console.
                        </td>
                    </tr>
                `;
                return;
            }
            
            if (studentsArray.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">
                            No students found. Add your first student above!
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Now safely use forEach
            studentsArray.forEach(function(student) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(student.name || 'N/A')}</td>
                    <td>${escapeHtml(student.grade || 'N/A')}</td>
                    <td>${escapeHtml(student.email || 'N/A')}</td>
                    <td>${student.joined_on ? new Date(student.joined_on).toLocaleDateString() : 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
            
            console.log('Students loaded successfully! Total:', studentsArray.length);
            
        } catch (error) {
            console.error('Error loading students:', error);
            const tableBody = document.getElementById('studentsTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: red;">
                            Error loading students: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
    }

    async function addStudent() {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const grade = document.getElementById('grade').value;

        // Basic validation
        if (!name || !email || !grade) {
            showAlert('Please fill in all fields', 'error');
            return;
        }

        const data = {
            name: name,
            email: email,
            grade: grade,
        };

        try {
            console.log('Adding student:', data);
            
            const response = await fetch('/api/students/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify(data)
            });

            console.log('Add student response status:', response.status);

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || JSON.stringify(errorData));
            }

            showAlert('Student added successfully!', 'success');
            
            // Clear form
            document.getElementById('name').value = '';
            document.getElementById('email').value = '';
            document.getElementById('grade').value = '';
            
            // Reload students
            loadStudents();
            
        } catch (error) {
            console.error('Error adding student:', error);
            showAlert('Error adding student: ' + error.message, 'error');
        }
    }

    function showAlert(message, type) {
        const alert = document.getElementById('alert');
        alert.textContent = message;
        alert.className = `alert alert-${type}`;
        alert.style.display = 'block';
        
        setTimeout(function() {
            alert.style.display = 'none';
        }, 5000);
    }

    // Get CSRF token for Django
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Security: Escape HTML to prevent XSS
    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return 'N/A';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
{% endblock %}
